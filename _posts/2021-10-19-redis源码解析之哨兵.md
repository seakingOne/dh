---
layout: post
title:  "2021-10-19-redis源码解析之哨兵"
date:   2021-10-19
desc: "redis sentinel"
keywords: "redis 集群 sentinel"
categories: [Database]
tags: [C/C++,redis,服务端]
icon: icon-html
---

Sentinel是Redis高可用性的解决方案：由一个或多个Sentinel实例组成的Sentinel系统可以监控多个主服务器，以及这些主服务器下的所有
从服务器，如下图所示：<br/>
<img src="{{ site.img_path }}/redis/sentinel/sentinel-1.png" width="65%"> <br/>

从图中可以看到，当前主服务器server1，三个从服务是server2，server3，server4，而Sentinel系统监视所有四个服务器<br/>

假设这时，主服务器server1进入下线状态，那么从服务器server2、server3、server4对主服务器的复制会被终止，并且Sentinel系统会察觉server1已经下线<br/>
会执行故障转移操作:<br/>
1）、Sentinel系统会挑选server1属下的一个从服务器，并将这个被选中的从服务器升级为新的主服务器<br/>
2）、Sentinel系统会向server1下所有的从服务器发送新的复制指令，让他们成为新的主服务器的从服务器，当所有从服务器都开始复制新的主服务器时，故障转移操作执行完毕<br/>
3）、另外，Sentinel还会继续监视已下线的server1，并在他重新上线时，将他设置为新的主服务器的从服务器<br/>

启动初始化Sentinel
    
    $ redis-sentinel /path/to/your/sentinel.conf
    或者命令
    $ redis-server /path/to/your/sentinel.conf --sentinel
    
    源码在初始化server的时候可以看到
    server.sentinel_mode = checkForSentinelMode(argc,argv);
    =====>
        int checkForSentinelMode(int argc, char **argv) {
            int j;
        
            if (strstr(argv[0],"redis-sentinel") != NULL) return 1;
            for (j = 1; j < argc; j++)
                if (!strcmp(argv[j],"--sentinel")) return 1;
            return 0;
        }

具体初始化逻辑在于:
        
    /* We need to init sentinel right now as parsing the configuration file
         * in sentinel mode will have the effect of populating the sentinel
         * data structures with master nodes to monitor. */
    if (server.sentinel_mode) {
        initSentinelConfig();
        initSentinel();
    }    
    
    在哨兵模式中，执行的语句有限制
    struct redisCommand sentinelcmds[] = {
        {"ping",pingCommand,1,"",0,NULL,0,0,0,0,0},
        {"sentinel",sentinelCommand,-2,"",0,NULL,0,0,0,0,0},
        {"subscribe",subscribeCommand,-2,"",0,NULL,0,0,0,0,0},
        {"unsubscribe",unsubscribeCommand,-1,"",0,NULL,0,0,0,0,0},
        {"psubscribe",psubscribeCommand,-2,"",0,NULL,0,0,0,0,0},
        {"punsubscribe",punsubscribeCommand,-1,"",0,NULL,0,0,0,0,0},
        {"publish",sentinelPublishCommand,3,"",0,NULL,0,0,0,0,0},
        {"info",sentinelInfoCommand,-1,"",0,NULL,0,0,0,0,0},
        {"role",sentinelRoleCommand,1,"l",0,NULL,0,0,0,0,0},
        {"client",clientCommand,-2,"rs",0,NULL,0,0,0,0,0},
        {"shutdown",shutdownCommand,-1,"",0,NULL,0,0,0,0,0}
    };
    
    初始化Sentinel时候，需要初始化Sentinel状态
    struct sentinelState {
    
        uint64_t current_epoch;     /* 当前纪元，用于实现故障转移 */
        
        // 保存了所有被这个sentinel监视的主服务器，key为主服务器的name，value为指向sentinelRedisInstance结构的指针
        dict *masters;
    
    }    