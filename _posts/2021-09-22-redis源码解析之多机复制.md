---
layout: post
title:  "redis源码解析之多机复制"
date:   2021-09-22
desc: "redis 集群 复制"
keywords: "redis 集群 复制"
categories: [Database]
tags: [C/C++,redis,服务端]
icon: icon-html
---

在Redis中，用户可以通过slaveof命令或者设置slaveof选项，让一个服务器去复制另一个服务器，我们称被复制的服务器为主服务器<br/>
，假设我们现在有2个Redis服务器，地址为127.0.0.1:6379和127.0.0.1:16379，如果我们向服务器127.0.0.1:16379发送以下命令：
    
    127.0.0.1:16379> slaveof 127.0.0.1:6379
    OK

那么服务器127.0.0.1:16379就是127.0.0.1:6379的从服务器，当然所有在主服务器上的操作，在从服务器中也会执行一次<br/>

*老版本复制功能的实现<br/>
Redis的复制分为同步和命令传播2个操作，同步操作用于将从服务器的数据库状态更新至主服务器当前所处的状态<br/>
命令传播则是用于在主服务器的数据库状态被修改，出现主从数据不一致时，让主从服务器重新处于一致状态<br/>

同步操作步骤：<br/>
1、从服务向主服务器发送SYNC命令<br/>
2、收到SYNC命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件，并使用缓冲区记录从现在开始执行的所有写命令<br/>
3、当主服务器的BGSAVE命令执行完毕后，主服务器会将BGSAVE生成的RDB文件传输给从服务器，从服务器载入RDB文件，开始执行写操作<br/>
4、主服务器将记录在缓冲区的所有写操作命令发送给从服务器，从服务器执行命令<br/>
   
命令传播：<br/>
     